<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chemistry Quiz Master</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS для чтения Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-xl mx-auto bg-white shadow rounded p-6 space-y-4">
    <h1 class="text-2xl font-bold text-center">Chemistry&nbsp;Quiz&nbsp;Master</h1>

    <!-- Категории -->
    <div>
      <label for="categorySelect" class="block font-medium mb-1">Категории</label>
      <select
        id="categorySelect"
        multiple
        class="w-full border rounded p-2 focus:outline-none focus:ring h-32 overflow-y-auto"
      ></select>
    </div>

    <!-- Сложность -->
    <div>
      <label for="difficultySelect" class="block font-medium mb-1">Сложность</label>
      <select
        id="difficultySelect"
        multiple
        class="w-full border rounded p-2 focus:outline-none focus:ring h-32 overflow-y-auto"
      ></select>
    </div>

    <!-- Кнопки управления -->
    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
      <button
        id="nextBtn"
        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded"
      >Следующий вопрос</button>
      <button
        id="showAnswerBtn"
        class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded hidden"
      >Show Answer</button>
    </div>

    <!-- Блок вопрос / ответ -->
    <div id="questionBox" class="mt-4 text-lg font-semibold min-h-[3rem]"></div>
    <div id="answerBox" class="mt-2 text-gray-700 hidden"></div>
  </div>

  <script>
    let rawData = [];
    let filteredData = [];

    /** Загружаем данные из DB.xlsx */
    async function loadData () {
      try {
        const response = await fetch('DB.xlsx');
        if (!response.ok) throw new Error('Не удалось загрузить DB.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        // предполагаем, что в книге есть колонки: Category | Difficulty | Question | Answer
        rawData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        populateFilters();
        applyFilters();
        showRandomQuestion();
      } catch (err) {
        console.error(err);
        document.getElementById('questionBox').textContent = 'Ошибка загрузки базы вопросов.';
      }
    }

    /** Заполняем выпадающие списки уникальными значениями */
    function populateFilters () {
      const categorySelect = document.getElementById('categorySelect');
      const difficultySelect = document.getElementById('difficultySelect');

      const categories = [...new Set(rawData.map(r => r.Category).filter(Boolean))].sort();
      const difficulties = [...new Set(rawData.map(r => r.Difficulty).filter(Boolean))].sort();

      categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
      difficultySelect.innerHTML = difficulties.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    /** Возвращает выбранные значения из <select multiple> */
    function getSelectedValues (selectEl) {
      return Array.from(selectEl.selectedOptions).map(o => o.value);
    }

    /** Применяем фильтры по выбранным категориям и сложностям */
    function applyFilters () {
      const selectedCategories = getSelectedValues(document.getElementById('categorySelect'));
      const selectedDifficulties = getSelectedValues(document.getElementById('difficultySelect'));

      filteredData = rawData.filter(r => {
        const okCat = selectedCategories.length === 0 || selectedCategories.includes(r.Category);
        const okDiff = selectedDifficulties.length === 0 || selectedDifficulties.includes(r.Difficulty);
        return okCat && okDiff;
      });
    }

    /** Показываем случайный вопрос из текущего фильтрованного списка */
    function showRandomQuestion () {
      const qBox = document.getElementById('questionBox');
      const aBox = document.getElementById('answerBox');
      const showBtn = document.getElementById('showAnswerBtn');

      if (filteredData.length === 0) {
        qBox.textContent = 'Нет вопросов для выбранных фильтров.';
        aBox.classList.add('hidden');
        showBtn.classList.add('hidden');
        return;
      }

      const rnd = Math.floor(Math.random() * filteredData.length);
      const { Question, Answer } = filteredData[rnd];

      qBox.textContent = Question;
      aBox.textContent = Answer;
      aBox.classList.add('hidden');
      showBtn.classList.remove('hidden');
    }

    // === Слушатели событий ===
    document.getElementById('showAnswerBtn').addEventListener('click', () => {
      document.getElementById('answerBox').classList.toggle('hidden');
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      applyFilters();
      showRandomQuestion();
    });

    document.getElementById('categorySelect').addEventListener('change', () => {
      applyFilters();
    });

    document.getElementById('difficultySelect').addEventListener('change', () => {
      applyFilters();
    });

    // Загружаемся!
    loadData();
  </script>
</body>
</html>
