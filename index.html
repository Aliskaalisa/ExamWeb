<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemistry Quiz Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for reading DB.xlsx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <main class="w-[70%] mx-auto py-6">
        <!-- Logo & Title -->
        <header class="flex items-center mb-6">
            <img src="chemistry.png" alt="Chemistry Logo" class="h-12 w-auto mr-4" />
            <h1 class="text-3xl font-bold text-gray-800">Chemistry Quiz Master</h1>
        </header>

        <!-- Controls Panel -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Choose Category -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Choose category</label>
                <div class="relative">
                    <button id="chooseToggle" class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-left flex justify-between items-center">
                        <span id="chooseSummary" class="truncate text-gray-700">Select…</span>
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="chooseMenu" class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></div>
                </div>
            </div>

            <!-- Exclude Category -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Exclude category</label>
                <div class="relative">
                    <button id="excludeToggle" class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-left flex justify-between items-center">
                        <span id="excludeSummary" class="truncate text-gray-700">Select…</span>
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="excludeMenu" class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></div>
                </div>
            </div>
        </section>

        <!-- Additional Options -->
        <section class="flex items-center gap-6 mb-6">
            <label class="inline-flex items-center">
                <input id="randomCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                <span class="ml-2 text-sm text-gray-700">Random order</span>
            </label>
            <label class="inline-flex items-center">
                <span class="mr-2 text-sm text-gray-700">Max Questions:</span>
                <input id="maxQuestions" type="number" min="1" class="w-20 px-2 py-1 border border-gray-300 rounded-md" />
            </label>
        </section>

        <!-- Questions Area -->
        <section id="questionsContainer" class="space-y-4"></section>
    </main>

    <script>
        // ================ DATA LOADING ===================
        let allQuestions = [];
        let categories = [];

        async function loadQuestions() {
            try {
                const response = await fetch('DB.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];

                // Convert sheet to JSON
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                // Expecting first row: Question | Answer | Category
                allQuestions = json.slice(1).map(r => ({
                    question: r[0],
                    answer: r[1],
                    category: r[2]
                })).filter(q => q.question && q.answer);

                // Extract unique categories
                categories = [...new Set(allQuestions.map(q => q.category))].sort();
                buildDropdowns();
                renderQuestions();
            } catch (err) {
                console.error('Error loading DB.xlsx:', err);
            }
        }

        // ================ DROPDOWN BUILDERS ===================
        function buildDropdowns() {
            const chooseMenu = document.getElementById('chooseMenu');
            const excludeMenu = document.getElementById('excludeMenu');
            chooseMenu.innerHTML = '';
            excludeMenu.innerHTML = '';

            categories.forEach(cat => {
                chooseMenu.appendChild(createCheckboxItem('choose', cat));
                excludeMenu.appendChild(createCheckboxItem('exclude', cat));
            });
        }

        function createCheckboxItem(prefix, category) {
            const id = `${prefix}-${category.replace(/\s+/g, '-')}`;
            const label = document.createElement('label');
            label.className = 'flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = id;
            input.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded';
            input.dataset.category = category;
            input.addEventListener('change', () => {
                updateSummaries();
                renderQuestions();
            });

            const span = document.createElement('span');
            span.className = 'ml-2 text-sm text-gray-700';
            span.textContent = category;

            label.appendChild(input);
            label.appendChild(span);
            return label;
        }

        function updateSummaries() {
            const chooseSummary = document.getElementById('chooseSummary');
            const excludeSummary = document.getElementById('excludeSummary');

            const chooseSelected = Array.from(document.querySelectorAll('#chooseMenu input:checked')).map(i => i.dataset.category);
            const excludeSelected = Array.from(document.querySelectorAll('#excludeMenu input:checked')).map(i => i.dataset.category);

            chooseSummary.textContent = chooseSelected.length ? chooseSelected.join(', ') : 'Select…';
            excludeSummary.textContent = excludeSelected.length ? excludeSelected.join(', ') : 'Select…';
        }

        // ================ QUESTION RENDERING ===================
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            const include = Array.from(document.querySelectorAll('#chooseMenu input:checked')).map(i => i.dataset.category);
            const exclude = Array.from(document.querySelectorAll('#excludeMenu input:checked')).map(i => i.dataset.category);
            const max = parseInt(document.getElementById('maxQuestions').value, 10) || Infinity;
            const random = document.getElementById('randomCheckbox').checked;

            let filtered = allQuestions.filter(q => {
                const inInclude = include.length === 0 || include.includes(q.category);
                const inExclude = exclude.includes(q.category);
                return inInclude && !inExclude;
            });

            if (random) {
                filtered = shuffleArray(filtered);
            }

            filtered.slice(0, max).forEach(({ question, answer }) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 border border-gray-200 rounded-md shadow-sm';

                const qText = document.createElement('p');
                qText.className = 'text-gray-800 font-medium';
                qText.textContent = question;

                const aText = document.createElement('p');
                aText.className = 'text-gray-700 mt-2 hidden';
                aText.textContent = answer;

                const btn = document.createElement('button');
                btn.className = 'mt-4 text-indigo-600 hover:underline';
                btn.textContent = 'Show Answer';
                btn.addEventListener('click', () => {
                    aText.classList.toggle('hidden');
                    btn.textContent = aText.classList.contains('hidden') ? 'Show Answer' : 'Hide Answer';
                });

                card.appendChild(qText);
                card.appendChild(aText);
                card.appendChild(btn);
                container.appendChild(card);
            });
        }

        // ================ HELPER FUNCTIONS ===================
        function shuffleArray(arr) {
            const clone = [...arr];
            for (let i = clone.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [clone[i], clone[j]] = [clone[j], clone[i]];
            }
            return clone;
        }

        // ================ DROPDOWN TOGGLE HANDLERS ===================
        document.getElementById('chooseToggle').addEventListener('click', () => toggleMenu('chooseMenu'));
        document.getElementById('excludeToggle').addEventListener('click', () => toggleMenu('excludeMenu'));
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#chooseToggle') && !e.target.closest('#chooseMenu')) {
                document.getElementById('chooseMenu').classList.add('hidden');
            }
            if (!e.target.closest('#excludeToggle') && !e.target.closest('#excludeMenu')) {
                document.getElementById('excludeMenu').classList.add('hidden');
            }
        });

        function toggleMenu(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        // Update on inputs
        document.getElementById('randomCheckbox').addEventListener('change', renderQuestions);
        document.getElementById('maxQuestions').addEventListener('input', renderQuestions);

        // INIT
        loadQuestions();
    </script>
</body>
</html>
